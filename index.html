<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Changepipe for OpenStreetMap</title>
    <link rel="stylesheet" href="http://js.mapbox.com/theme/dark.css" type="text/css">
    <style type="text/css">
    
        body, button
        {
        	font-family: Arial, Helvetica, sans-serif;
        	font-size: 14px;
        	line-height: 18px;
        }
        
        #content
        {
            width: 900px;
            margin: 2em;
        }

        #content>div, #content>p
        {
            margin: 1em 0;
        }

        #map
        {
            position: relative;
            height: 500px;
            border: 1px solid #808080;
        }
        
        #wkt-display
        {
            color: #fc0;
            background-color: #404040;
            padding: .5em;
            -o-border-radius: 3px;
            -ms-border-radius: 3px;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
        }
        
        .olControlAttribution
        {
            bottom: 1px;
            left: 1px;
        }
        
        #buttons
        {
            position: absolute;
            z-index: 999;
            top: 12px;
            right: 6px;
        }
        
        #buttons button
        {
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 3px;
            padding: 4px 8px;
            border: none;
            color: white;
        }

    </style>
    <!--
    <script src="http://openlayers.org/dev/OpenLayers.js"></script>
    -->
    <script src="OpenLayers.js"></script>
    <script type="text/javascript">
        var map, vectors, polygon, modify;
        
        var lonlat = new OpenLayers.Projection('EPSG:4326'),
            merc = new OpenLayers.Projection('EPSG:900913');
        
        OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";

        function init()
        {
            map = new OpenLayers.Map('map', { displayProjection: lonlat });
            var osm = new OpenLayers.Layer.OSM('OSM');
            OpenLayers.Feature.Vector.style['default']['strokeWidth'] = '2';

            vectors = new OpenLayers.Layer.Vector("Vector Layer", { renderers: ['Canvas', 'SVG', 'VML'] });

            map.addLayers([osm, vectors]);
            map.addControl(new OpenLayers.Control.MousePosition());
            
            vectors.events.on({
                "afterfeaturemodified": finishDrawing,
                "featuremodified": finishDrawing,
                "featureadded": finishDrawing
            });

            polygon = new OpenLayers.Control.DrawFeature(vectors, OpenLayers.Handler.Polygon)
            map.addControl(polygon);
            
            modify = new OpenLayers.Control.ModifyFeature(vectors);
            map.addControl(modify);
            modify.activate();
            
            map.setCenter(new OpenLayers.LonLat(0, 0), 2);
        }
        
        function clearPolygons()
        {
            while(vectors.features.length)
            {
                vectors.features[0].destroy();
            }
            
            finishDrawing();
            document.getElementById('wkt-email').href = 'mailto:mike@stamen.com?subject=' + escape("I don't have a polygon for you but I'm mailing you anyway about Changepipe");
        }
        
        function addPolygon()
        {
            modify.deactivate();
            polygon.activate();
        }
        
        function addedPolygon()
        {
            finishDrawing();
        }
        
        function finishDrawing()
        {
            polygon.deactivate();
            modify.activate();
            
            var wkt = featuresWKT(vectors.features);
            document.getElementById('wkt-display').innerText = wkt;
            document.getElementById('wkt-email').href = 'mailto:mike@stamen.com?subject=' + escape('Make me a changepipe') + '&body='+escape(wkt);
        }
        
        function featuresWKT(features)
        {
            var rings = [];
        
            for(var i in features)
            {
                var geometry = vectors.features[i].geometry;

                if(geometry.CLASS_NAME == 'OpenLayers.Geometry.Polygon')
                {
                    var ring = geometry.components[0],
                        pt = undefined,
                        points = [];
                    
                    for(var j in ring.components)
                    {
                        pt = geometry.components[0].components[j];
                        pt = OpenLayers.Projection.transform({x: pt.x, y: pt.y}, merc, lonlat);
                        points.push(pt.x.toFixed(3) + ' ' + pt.y.toFixed(3));
                    }
                    
                    rings.push('(' + points.join(', ') + ')');
                }
            }
            
            if(rings.length == 1) {
                return 'POLYGON ' + rings[0];
            
            } else if(rings.length > 1) {
                return 'MULTIPOLYGON ((' + rings.join(', ') + '))';
            
            } else {
                return '';
            }
        }
        
    </script>
  </head>
  <body onload="init()">
    <div id="content">
        <h1>The Changepipe</h1>
        <p>
            Get notified via RSS when OpenStreetMap has been edited in your area.
        </p>
        <p>
            Draw a polygon on the map below using the “Draw Polygon” button,
            and I’ll generate for you an RSS feed of links to changesets
            <a href="http://osm-changepipe.s3.amazonaws.com/bay-area.xml">like this</a>.
        </p>
        <div id="map">
            <div id="buttons">
                <button onclick="addPolygon();">Draw Polygon</button>
                <button onclick="clearPolygons();">Clear Drawing</button>
            </div>
        </div>
        <p id="wkt-display"><span style="color: #999;">Draw something above.</span></p>
        <p>
            Things are still fairly primitive around here, so when you’re done drawing
            an outline around your local area, 
            <a id="wkt-email" href="mailto:mike@stamen.com">send me an email</a>
            with the complete contents of the box above, and try not to ask for giant,
            busy areas like all of Germany or the United States. Changepipe works best
            for limited areas like single towns or counties, and you can draw more than
            one area and have that be a single subscription. I’ll mail you back with
            a URL to your feed that you can subscribe to in a reader or do other
            things with in services like <a href="http://ifttt.com">If This Then That</a>.
        </p>
        <p>
            A thing by <a href="http://mike.teczno.com">Michal Migurski</a>.
            Fork me <a href="https://github.com/migurski/Changepipe">on Github</a>.
        </p>
    </div>
  </body>
</html>
